var Charts=new function(){this.base=function(a,b){var c={};return c.data=a,c.draw=function(){},c.tooltips=function(){},c.labels=function(){},c.axes=function(){},c.access=function(a,b){return"Array"==typeof b?"function"==typeof a?d3.map(b,a):d3.map(b,function(b){return b[a]}):"function"==typeof a?a(b):b[a]},c.sort=function(){c.options.sort&&"function"==typeof c.options.sort?c.data=c.data.sort(c.options.sort):c.options.sort&&c.data.sort(function(a,b){return"desc"==c.options.sort?b.total-a.total:a.total-b.total})},c.offset=function(){return c.options.limit&&"function"==typeof c.data.slice&&(c.data=c.data.slice(0,c.options.limit)),c.data},c.coords=function(){c.y=d3.scale.ordinal().rangeRoundBands([c.options.margin.top,c.height],.1).domain(c.data.map(function(a){return c.access(c.options.axis.y.label,a)})),c.x=d3.scale.linear().rangeRound([c.width,0]).domain([d3.max(c.data,function(a){return a.total}),0])},c.legend=function(){if(c.options.legend){var a=c.svg.selectAll(".legend").data(c.options.stack).enter().append("g").attr("class","legend").attr("transform",function(a,b){return"translate(-20,"+20*b+")"});a.append("rect").attr("x",c.width-18).attr("width",18).attr("height",18).style("fill",function(a){return c.access(a.color,a)}),a.append("text").attr("x",c.width-24).attr("y",9).attr("dy",".35em").style("text-anchor","end").text(function(a){return c.access(a.legend,a)})}},c.axis=function(){if(c.yAxis=d3.svg.axis().scale(c.y).tickSize(c.width).ticks(5).orient("right"),c.xAxis=d3.svg.axis().scale(c.x).orient("bottom").tickSize(10),c.options.axis.x.show){c.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+c.height+")").call(c.xAxis)}if(c.options.axis.y.show){var a=c.svg.append("g").attr("class","y axis").call(c.yAxis);a.selectAll("text").attr("x",4).attr("dy",-4)}},c.setup=function(a){return c.options.dom?(c.element=$(c.options.dom),c.element.children("svg").remove(),c.options.width&&!a?c.width=c.options.width-(c.options.margin.left+c.options.margin.right):(c.options.width=c.element.width(),c.width=c.element.width()-(c.options.margin.left+c.options.margin.right)),c.options.height?c.height=c.options.height-(c.options.margin.left+c.options.margin.right):(c.options.height=c.element.height(),c.height=c.element.height()-(c.options.margin.left+c.options.margin.right)),c.element=d3.selectAll(c.options.dom),c.svg=c.element.append("svg").attr("width",c.width+c.options.margin.left+c.options.margin.right).attr("height",c.height+c.options.margin.top+c.options.margin.bottom).append("g").attr("class","chart").attr("transform","translate("+c.options.margin.left+","+c.options.margin.top+")"),c.sort(),c.offset(),c.coords(),c.element):!1},$(".label-segment").mouseout(function(){}),c.events=function(){var a=d3.tip().attr("class","d3-tip").html(function(a){return a.label||a.data.label});c.svg.call(a),c.svg.selectAll(".labelled").on("mouseover",a.show).on("mouseout",a.hide),c.options.stack.forEach(function(a,b){a.click&&c.svg.selectAll(".stack-"+b).on("click",a.click),a.mouseover&&c.svg.selectAll(".stack-"+b).on("mouseenter",a.mouseover),a.mouseout&&c.svg.selectAll(".stack-"+b).on("mouseleave",a.mouseout)})},c.update=function(a){c.data=a,c.draw()},c.resize=function(){c.setup(!0),c.draw(),c.axis(),c.legend()},c.create=function(){c.setup(),c.draw(),c.axis(),c.legend(),c.events(),$(".labelled").tooltip({trigger:"hover"})},c.defaults={create:!1,height:!1,width:!1,margin:{top:20,right:20,bottom:30,left:20},label:"",stack:[],legend:!0,chartLabel:!0,axis:{x:{show:!0},y:{show:!0}},limit:!1},c.options=_.extend(c.defaults,b||{}),c}};Charts.bar=function(a,b){var c=new Charts.base(a,{});return c.options=_.extend(c.options,b||{}),c.coords=function(){if(1==c.options.timeseries){if(c.x=d3.time.scale().range([0,c.width]),c.options.axis.x.extent)var a=c.options.axis.x.extent;else var a=d3.extent(c.data,function(a){return c.access(c.options.axis.x.label,a)});c.x.domain(a)}else c.y=d3.scale.ordinal().rangeBands([0,c.height],.1).domain(c.data.map(function(a){return c.access(c.options.axis.y.label,a)}));c.x=d3.scale.linear().rangeRound([0,c.width]).domain([0,d3.max(c.data,function(a){var b=0;return c.options.stack.forEach(function(d){var e=a;return e.label=c.access(d.label,a),e.key=c.access(d.key,a),e.color=c.access(d.color,a),e.y0=b,e.y1=b+e.key,b=e.y1}),b})])},c.draw=function(){var a=c.svg.selectAll(".bar").data(c.data).enter().append("g").attr("class","bar").attr("transform",function(a){return"translate(0,"+c.y(c.access(c.options.axis.y.label,a))+")"}),b=a.selectAll(".segment").data(function(a){var b=0,d=[];return c.options.stack.forEach(function(e){var f={data:a,label:c.access(e.label,a),key:c.access(e.key,a),color:c.access(e.color,a),y0:b};f.y1=b+f.key,b=f.y1,f.y1>f.y0&&d.push(f)}),d});b.transition().duration(750).style("fill-opacity",1e-6),b.enter().append("g").attr("class",function(a,b){return"segment stack-"+b}).attr("data-label",function(a){return a.label}).style("fill-opacity",1e-6).transition().duration(750).style("fill-opacity",1),b.exit().attr("class","exit").transition().duration(750).style("fill-opacity",1e-6).remove(),b.append("rect").attr("class","poly").attr("height",c.y.rangeBand()).attr("width",function(a){return c.x(a.y1)-c.x(a.y0)}).attr("x",function(a){return c.x(a.y0)}).style("fill",function(a){return a.color});var d=b.append("g").attr("class","label").attr("x",function(a){return c.x(a.y0)+4}).attr("y",function(a,b){return 10*b+10}).style("text-anchor","left").text(function(a){return a.label});d.append("rect").attr("class","label-background").attr("x",function(a){return c.x(a.y0)+4}).attr("y",function(a,b){return 10*b+10}).attr("width",100).attr("height",20).fill("#FFFFFF"),d.append("text").attr("class","label-text").attr("x",function(){return 4}).attr("y",function(){return 4}).style("text-anchor","left").text(function(a){return a.label})},1==c.options.create&&c.create(),c},Charts.column=function(a,b){var c=new Charts.base(a,{});return c.options=_.extend(c.options,b||{}),c.coords=function(){if(1==c.options.timeseries){if(c.x=d3.time.scale().range([0,c.width]),c.options.axis.x.extent)var a=c.options.axis.x.extent;else var a=d3.extent(c.data,function(a){return c.access(c.options.axis.x.label,a)});c.x.domain(a)}else c.x=d3.scale.ordinal().rangeRoundBands([0,c.width],.1).domain(c.data.map(function(a){return c.access(c.options.axis.x.label,a)}));var b=d3.max(c.data,function(a){var b=0;return c.options.stack.forEach(function(d){var e=a;return e.label=c.access(d.label,a),e.key=c.access(d.key,a),e.color=c.access(d.color,a),e.y0=b,e.y1=b+e.key,b=e.y1}),b});c.y=d3.scale.linear().rangeRound([c.height,0]).domain([0,b])},c.draw=function(){c.svg.attr("class","column chart");var a=c.svg.selectAll(".bar").data(c.data).enter().append("g").attr("class","bar").attr("transform",function(a){return"translate("+c.x(c.access(c.options.axis.x.label,a))+", 0)"}),b=a.selectAll(".segment").data(function(a){var b=0,d=[];return c.options.stack.forEach(function(e){var f={data:a,label:c.access(e.label,a),key:c.access(e.key,a),color:c.access(e.color,a),y0:b};f.y1=b+f.key,b=f.y1,f.y1>f.y0&&d.push(f)}),d});b.transition().duration(750).style("fill-opacity",1e-6),b.enter().append("g").attr("class",function(a,b){return"segment labelled stack-"+b}).attr("title",function(a){return a.label}).style("fill-opacity",1e-6).transition().duration(750).style("fill-opacity",1),b.exit().attr("class","exit").transition().duration(750).style("fill-opacity",1e-6).remove(),b.append("rect").attr("class","poly").attr("width",c.x.rangeBand()).attr("height",function(a){return c.y(a.y0)-c.y(a.y1)}).attr("y",function(a){return c.y(a.y1)}).style("fill",function(a){return c.access("color",a)})},1==c.options.create&&c.create(),c},Charts.pie=function(a,b){var c=new Charts.base(a,b);return b=_.extend(c.defaults,{},b||{}),c.draw=function(){c.svg.attr("class","pie chart");var a=Math.min(c.width,c.height)/2,b=(d3.scale.ordinal().range(["#98abc5","#8a89a6","#7b6888","#6b486b","#a05d56","#d0743c","#ff8c00"]),d3.svg.arc().outerRadius(a*(c.options.radius||1)).innerRadius(a*(c.options.innerRadius||.5))),d=d3.layout.pie().sort(null).value(function(a){return c.access(c.options.stack[0].key,a)});c.svg.attr("transform","translate("+c.width/2+","+c.height/2+")");var e=c.svg.selectAll(".arc").data(d(c.data)).enter().append("g").attr("class","chart-unit");e.append("path").attr("d",b).attr("class","labelled").style("fill",function(a){return c.access(c.options.stack[0].color,a)}).attr("title",function(a){return c.access(c.options.stack[0].label,a)})},1==c.options.create&&c.create(),c},Charts.line=function(a,b){var c=new Charts.base(a,b);return b=_.extend(c.defaults,b||{}),c.coords=function(){if(1==c.options.timeseries){if(c.x=d3.time.scale().range([0,c.width]),c.options.axis.x.extent)var b=c.options.axis.x.extent;else var b=d3.extent(a,function(a){return c.access(c.options.axis.x.label,a)});c.x.domain(b)}else c.x=d3.scale.ordinal().rangePoints([0,c.width],.1).domain(c.data.map(function(a){return c.access(c.options.axis.x.label,a)}));var d=d3.max(c.options.stack,function(a){return d3.max(c.data,function(b){return c.access(a.key,b)})});c.y=d3.scale.linear().rangeRound([c.height,0]).domain([0-.05*d,d])},c.draw=function(){if(c.svg.attr("class","chart line"),c.options&&c.options.stack){var b=[];c.options.stack.forEach(function(d){var e=c.data.map(function(a){return{x:c.access(c.options.axis.x.label,a),y:c.access(d.key,a),label:c.access(d.label,a)}});if(c.line=d3.svg.line().interpolate(c.options.interpolate||"cardinal").x(function(a){return c.x(a.x)}).y(function(a){return c.y(a.y)}),c.options.timeseries){if(c.options.axis.x.extent)var f=c.options.axis.x.extent;else var f=d3.extent(a,function(a){return c.access(c.options.axis.x.label,a)});var g=d3.time.day.range(f[0],f[1]);1==c.options.axis.x.fill&&g.forEach(function(a){var b=g[b],c=0;e.forEach(function(b){b.x.toISOString().substr(0,10)==a.toISOString().substr(0,10)&&c++}),0==c&&e.push({x:new Date(a.toISOString().substr(0,10)),y:0,label:null})}),e=e.sort(function(a,b){return a.x-b.x})}else{c.x(c.access(c.options.axis.x.label,c.data[1]))/2}var h=c.svg.append("g").attr("class","line-obj"),i=(h.append("path").attr("class","line").attr("d",c.line(e)).style("stroke",function(a){return c.access(d.color,a)}).style("fill",function(a){return c.access(d.color,a)}),h.selectAll(".marker").data(e).enter().append("g").attr("class","marker"));i.append("circle").attr("cx",function(a){return c.x(a.x)}).attr("cy",function(a){return c.y(a.y)}).attr("r",6).style("fill",function(a){return c.access(d.color,a)}).style("stroke",function(a){return c.access(d.color,a)}).attr("class","labelled").attr("title",function(a){return a.label}),b.push(i[0])})}},1==c.options.create&&c.create(),c};